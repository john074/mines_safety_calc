{% extends 'layout.html' %}

{% block title %}
    Журнал расчётов
{% endblock %}

{% block content %}
<h1 class="header">Журнал расчётов</h1>

<div class="search-form">
    <a href="?calc_type=main"
       class="btn-secondary {% if calc_type == 'main' %}btn-primary{% endif %}">
        Риски предприятий
    </a>
    <a href="?calc_type=risk"
       class="btn-secondary {% if calc_type == 'risk' %}btn-primary{% endif %}">
        Индивидуальные риски
    </a>
</div>

<form method="get" class="search-form">
    <input type="hidden" name="calc_type" value="{{ calc_type }}">

    <select name="filter_by">
        {% if calc_type == "risk" %}
            <option value="industry__name">Отрасль</option>
        {% else %}
            <option value="organisation__INN">ИНН</option>
            <option value="organisation__name">Наименование</option>
        {% endif %}
        <option value="user">Пользователь</option>
    </select>

    <input type="text" name="query" placeholder="Поиск..." value="{{ request.GET.query }}">

    <label>Создан с:
        <input type="date" name="created_from" value="{{ request.GET.created_from }}">
    </label>
    <label>по:
        <input type="date" name="created_to" value="{{ request.GET.created_to }}">
    </label>

    <button type="submit">Поиск</button>
</form>

<div class="calc-log">
  <table class="calc-table">
    <thead>
      <tr>
        {% for field, label in headers.items %}
        <th>
            <a href="?calc_type={{ calc_type }}&sort={% if current_sort == field %}-{{ field }}{% else %}{{ field }}{% endif %}">
                {{ label }}
            </a>
        </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
        {% for entry in calculations %}
            <tr class="clickable-row"
                {% if calc_type == "risk" %}
                    data-href="{% url 'calculations:risk_calc_result' entry.id %}"
                {% else %}
                    data-href="{% url 'calculations:calc_details' entry.id %}"
                {% endif %}>
                <td>
                    {{ entry.user.get_full_name|default:entry.user.username }}
                </td>
                <td>{{ entry.created|date:"d.m.Y H:i" }}</td>

                {% if calc_type == "risk" %}
                    <td>{{ entry.industry.name }}</td>
                    <td>{{ entry.year }}</td>
                    <td>{{ entry.result }}</td>
                {% else %}
                    <td>{{ entry.organisation.INN }}</td>
                    <td>{{ entry.organisation.name }}</td>
                    <td>
                        {% if entry.is_complete %}
                            <span class="status complete">Завершён</span>
                        {% else %}
                            <span class="status in-progress">Не завершён</span>
                        {% endif %}
                    </td>
                {% endif %}
            </tr>
        {% empty %}
            <tr>
                <td colspan="6" style="text-align:center;">
                    Нет доступных расчётов
                </td>
            </tr>
        {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
